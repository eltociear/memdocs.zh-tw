---
title: 資料庫複寫
titleSuffix: Configuration Manager
description: 了解 Configuration Manager 資料庫複寫如何使用 SQL Server 來傳輸階層中的資料。
ms.date: 08/09/2019
ms.prod: configuration-manager
ms.technology: configmgr-core
ms.topic: conceptual
ms.assetid: 8b495b02-c966-4eb3-92b9-52ebbf5c38ae
author: mestew
ms.author: mstewart
manager: dougeby
ms.openlocfilehash: d1a2c8baa349e6499aa483f947d94f7459357be4
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/21/2020
ms.locfileid: "81703596"
---
# <a name="database-replication"></a>資料庫複寫

適用於：  Configuration Manager (最新分支)

Configuration Manager 資料庫複寫會使用 SQL Server 來傳輸資料。 它會使用這個方法，將其站台資料庫中的變更與階層中其他站台資料庫的資訊合併。

請注意下列有關資料庫複寫的要點︰

- 所有站台都共用相同資訊。  

- 在階層中安裝站台時，Configuration Manager 會在新站台與父站台之間自動建立資料庫複寫。  

- 網站安裝完成後，就會自動開始進行資料庫複寫。  

當您將新的站台新增至階層時，Configuration Manager 會在新站台建立一般資料庫。 父站台會建立其資料庫中相關資料的快照集。 接著，它會使用[檔案型複寫](file-based-replication.md)將快照集傳輸至新站台。 然後，新站台會使用 SQL Server 大量複製程式 (BCP)，將資訊載入 Configuration Manager 資料庫的本機複本中。 載入快照後，每個網站都會和其他網站一起執行資料庫複寫。  

為了在網站間複寫資料，Configuration Manager 會使用其擁有的資料庫複寫服務。 資料庫複寫服務會使用 SQL Server 變更追蹤來監視本機站台資料庫的變更。 接著，它會使用 SQL Server Service Broker (SSB)，將變更複寫至其他站台。 根據預設，這個程序會使用 TCP 連接埠 4022。  


## <a name="replication-groups"></a>複寫群組

Configuration Manager 會將資料庫複寫所複寫的資料分門別類到不同的複寫群組內。 每個複寫群組都有個別的固定複寫排程。 站台會使用此排程來判斷它將變更複寫至其他站台的頻率。  

例如，針對角色型系統管理設定的變更會快速地複寫到其他站台。 此行為可確保其他站台能夠快速地強制執行這些變更。 優先順序較低的設定變更 (如要求安裝新的次要站台) 沒有急迫複寫的需求。 可能需要數分鐘的時間，才會將新站台要求送達目的地主要站台。  


## <a name="settings"></a>設定

您可以修改下列資料庫複寫設定：  

- **資料庫複寫連結**：控制特定流量何時周遊網路。  

- **分散式檢視**：當管理中心網站 (CAS) 要求選取的站台資料時，可從子主要站台資料庫直接存取該資料。  

- **排程**：指定何時使用複寫連結，以及何時複寫不同類型的站台資料。  

- **摘要**：變更可周遊複寫連結之網路流量的資料摘要設定。 根據預設，每隔 15 分鐘便會摘要一次。 可用於資料庫複寫報表中。  

- **資料庫複寫閾值**：定義站台報告連結降級或失敗的時間。 您也可以設定 Configuration Manager 何時發出有關具有降級或失敗狀態之複寫連結的警示。  


## <a name="types-of-data"></a>資料類型

Configuration Manager 會將複寫的資料主要分類為*全域資料*或*站台資料*。 發生資料庫複寫時，站台會將全域資料和站台資料的變更傳輸到所有的資料庫複寫連結。 全域資料會複寫至父或子站台。 站台資料只能複寫至父站台。 第三種資料類型 (即*本機資料*) 不會複寫至其他站台。 本機資料是其他站台不需要的資訊。  

### <a name="global-data"></a>全域資料

全域資料是系統管理員建立的物件，可複寫至整個階層中的所有站台。 次要站台只會接收全域資料的子集，作為全域 Proxy 資料。 您會在 CAS 和主要站台上建立全域資料。 此類型包括下列資料：

- 軟體部署
- 軟體更新
- 集合定義
- 以角色為基礎的系統管理安全性範圍

### <a name="site-data"></a>網站資料

站台資料是由 Configuration Manager 主要站台及其指派的用戶端所建立的操作資訊。 站台資料會複寫到 CAS，但不會複寫到其他主要站台。 您只能從資料最初來源的 CAS 和主要站台檢視站台資料。 您只能在建立資料所在的主要站台上修改站台資料。 此類型包括下列資料：

- 硬體清查
- 狀態訊息
- 警示
- 查詢式集合的結果

所有站台資料都會複寫到 CAS。 CAS 會為整個站台階層進行系統管理和報告。  


## <a name="database-replication-links"></a><a name="bkmk_Dblinks"></a> 資料庫複寫連結

在階層中安裝新站台時，Configuration Manager 會在父站台與新站台之間自動建立資料庫複寫連結。 它會建立單一連結，以連線兩個站台。  

若要控制跨複寫連結的資料傳輸，請變更每個連結的設定。 每個複寫連結支援個別的設定。 每個資料庫複寫連結都包含下列控制項：  

- 停止將所選站台資料從主要站台複寫至 CAS。 此動作會造成 CAS 直接從主要站台的資料庫存取此資料。  

- 排定將選取的站台資料從子主要站台傳輸到 CAS。

- 定義判斷資料庫複寫連結狀態為降級或失敗時的設定。

- 指定何時發出複寫連結失敗的警示。

- 指定 Configuration Manager 摘要使用複寫連結之複寫流量資料的頻率。 它會在報表中使用此資料。

若要設定資料庫複寫連結，在 Configuration Manager 主控台中，移至 [監視]  工作區。 選取 [資料庫複寫]  節點，然後編輯連結的屬性。 此節點也位於 [系統管理]  工作區的 [階層設定]  節點底下。 從複寫連結的父站台或子站台編輯複寫連結。  

> [!TIP]  
> 您可以從其中一個工作區的 [資料庫複寫]  節點編輯資料庫複寫連結。 不過，當您使用 [監視]  工作區中的 [資料庫複寫]  節點時，也可以檢視資料庫複寫的狀態。 它也會提供[複寫連結分析師](../../servers/manage/monitor-replication.md#BKMK_RLA)工具的存取權。 使用此工具協助調查資料庫複寫的問題。  

如需如何設定複寫連結的詳細資訊，請參閱[站台資料庫複寫控制](#BKMK_DBRepControls)。 如需有關如何監視複寫的詳細資訊，請參閱[監視資料庫複寫](../../servers/manage/monitor-replication.md)。  


## <a name="distributed-views"></a><a name="bkmk_distviews"></a> 分散式檢視  

透過分散式檢視，當您在 CA 上針對選取的站台資料提出要求時，它會直接存取子主要站台上的資料庫。 直接存取會取代從主要站台將該站台資料複寫到 CAS 的需求。 由於每個複寫連結與其他複寫連結各自獨立，因此您能在您選擇的複寫連結上使用分散式檢視。 您無法在主要站台與次要站台之間使用分散式檢視。  

分散式檢視可提供以下優勢：  

- 降低處理 CAS 和主要站台之資料庫變更方面的 CPU 負載

- 降低經由網路傳輸到 CAS 的資料量

- 改善裝載 CAS 資料庫之 SQL Server 的效能

- 減少 CAS 資料庫所使用的磁碟空間

當主要站台在網路上和 CAS 十分接近，且兩個站台持續開啟並保持連線時，請考慮使用分散式檢視。 分散式檢視會以每個站台上 SQL Server 間的直接連線，取代站台間所選資料的複寫。 CAS 會在您每次要求此資料時建立直接連線。

站台會要求下列範例案例中的分散式檢視資料：

- 當您執行報表或查詢時
- 當您在資源總管中檢視資訊時
- 包含以站台資料為基礎的規則之集合的集合評估

根據預設，每個複寫連結都會關閉分散式檢視。 當您開啟分散式檢視時，您要選取不會跨該連結複寫至 CAS 的站台資料。 CAS 會直接從共用連結的子主要站台資料庫存取此資料。 您可以針對分散式檢視設定以下網站資料類型：  

- 來自用戶端的**硬體清查**資料
- 來自用戶端的**軟體清查和軟體計量**資料
- 來自用戶端、主要站台和所有次要站台的**狀態訊息**

當您檢視 Configuration Manager 主控台或報告內的資料時，在操作上看不到分散式檢視。 當您要求為分散式檢視啟用的資料時，CAS 站台資料庫伺服器會直接存取子主要站台的資料庫來擷取資訊。

例如，您使用連線到 CAS 的 Configuration Manager 控制台。 您會向兩個主要站台要求硬體清查的相關資訊：ABC 與 XYZ。 您在站台 ABC 僅啟用分散式檢視的硬體清查。 CAS 會從它自己的資料庫擷取 XYZ 用戶端的清查資訊。 CAS 會直接從站台 ABC 的資料庫擷取 ABC 用戶端的清查資訊。 此資訊會顯示在 Configuration Manager 主控台或報表中，而不需識別來源。  

如果複寫連結具備針對分散式檢視啟用的資料類型，子主要站台就不會將資料複寫至 CAS。 當您關閉某個資料類型的分散式檢視時，子主要站台就會恢復將一般資料複寫至 CAS。 此資料的複寫群組必須在主要站台與 CAS 間重新初始化，才能於 CAS 上看到此資料。 在您解除安裝已開啟分散式檢視的主要站台之後，CAS 必須先完成其資料的重新初始化，您才能存取在 CAS 上啟用分散式檢視的資料。  

> [!IMPORTANT]  
> 在站台階層的任何複寫連結上使用分散式檢視時，請關閉所有複寫連結的分散式檢視，再解除安裝任何主要站台。 如需詳細資訊，請參閱[解除安裝使用分散式檢視的主要站台](../../servers/deploy/install/uninstall-sites-and-hierarchies.md#bkmk_distviews)。  

### <a name="prerequisites-and-limitations-for-distributed-views"></a>分散式檢視的先決條件和限制  

- 只能在 CAS 與主要站台之間的複寫連結上，使用分散式檢視。

- CAS 必須使用 SQL Server Enterprise Edition。 主要站台沒有這項需求。

- CAS 只能有一個 SMS 提供者的執行個體。 在站台資料庫伺服器上安裝單一執行個體。 此設定支援 Kerberos 驗證。 CAS 上的 SQL server 需要 Kerberos，才能存取子主要站台上的 SQL Server。 對於子主要網站上的 SMS 提供者，沒有任何限制。

- 您只能在 CAS 上安裝一個 Reporting Services 點。 在站台資料庫伺服器上安裝 SQL Server Reporting Services。 此設定支援 Kerberos 驗證。 CAS 上的 SQL server 需要 Kerberos，才能存取子主要站台上的 SQL Server。

- 您無法在 [SQL Server 叢集](../../servers/deploy/configure/use-a-sql-server-cluster-for-the-site-database.md)上裝載站台資料庫。

- 在 1902 版和更舊版本中，您無法在 [SQL Server Always On 可用性群組](../../servers/deploy/configure/sql-server-alwayson-for-a-highly-available-site-database.md)上裝載站台資料庫。 若要支援此設定，請更新至 1906 版或更新版本。<!-- SCCMDocs-pr#3792 -->

- CAS 資料庫伺服器的電腦帳戶需要主要站台資料庫的 [讀取]  權限。

> [!IMPORTANT]  
> 分散式檢視及資料複寫[排程](#BKMK_schedules)，都是資料庫複寫連結的互斥設定。  


## <a name="schedule-transfers-of-site-data"></a><a name="BKMK_schedules"></a> 排程站台資料的傳輸

為協助您控制用來將站台資料從子主要站台複寫至 CAS 的網路頻寬，請排程使用複寫連結的時機。 然後指定複寫不同類型之站台資料的時機。 您可以控制主要網站何時複寫狀態訊息、清查和計量資料。 來自次要站台的資料庫複寫連結不支援站台資料的排程。 您無法排程全域資料的傳輸。  

當您設定資料庫複寫連結排程時，可以限制將選取的站台資料從主要站台傳輸至 CAS。 您也可以設定不同的時間複寫不同類型的站台資料。  

> [!IMPORTANT]  
> [分散式檢視](#bkmk_distviews)及資料複寫排程，都是資料庫複寫連結的互斥設定。  


## <a name="summarization-of-traffic"></a><a name="BKMK_SummarizeDBReplication"></a> 流量摘要  

每個站台都會定期將有關周遊站台的資料庫複寫連結之網路流量的資料，製作成摘要。 站台會將摘要資料用於資料庫複寫報表中。 複寫連結上的兩個網站，都會將周遊複寫連結的網路流量製做為摘要。 站台資料庫伺服器會摘要說明資料。 摘要說明資料之後，此資訊即會複寫至其他站台作為全域資料。  

根據預設，每隔 15 分鐘便會摘要一次。 若要修改網路流量摘要的頻率，請編輯資料庫複寫連結內容中的 [摘要間隔]  。 摘要的頻率會影響您在資料庫複寫報表中檢視的資訊。 您可以選擇 5 到 60 分鐘的間隔。 當您增加摘要的頻率時，便會增加複寫連結上各網站的 SQL Server 處理負載。  

## <a name="database-replication-thresholds"></a><a name="BKMK_DBRepThresholds"></a> 資料庫複寫閾值

資料庫複寫閾值會定義 Configuration Manager 將資料庫複寫連結的狀態報告為降級或失敗的時機。 根據預設，當有任何一個複寫群組連續 12 次都無法完成複寫時，即會將連結設為 [降級]  。 當有任何複寫群組連續 24 次都無法複寫時，則會將連結設為 [失敗]  。  

您可以指定降級或失敗狀態的自訂值。 如果您調整這些值，可以更精確地監視跨連結的資料庫複寫健全狀況。  

一或多個複寫群組可能無法複寫，而其他複寫群組則會繼續成功複寫。 規劃在第一次報告為降級時，檢閱連結的複寫狀態。

在下列情況下，請考慮修改連結的降級或失敗狀態重試值：

- 特定複寫群組有重複的延遲，而且其延遲不是問題

- 站台間的網路連結具有低可用頻寬

當您增加站台將連結設為降級或失敗之前的重試次數時，可以減少已知問題的錯誤警告。 此動作可讓您更精確地追蹤連結的狀態。  

若要了解該群組複寫的頻率，您可以將各複寫群組的複寫同步間隔納入考慮。 若要檢視複寫群組的**複寫間隔**，請移至 Configuration Manager 主控台中的 [監視]  工作區。 在 [資料庫複寫]  節點中，選取複寫連結的 [複寫詳細資料]  索引標籤。  

如需如何監視資料庫複寫 (包括如何檢視複寫狀態) 的詳細資訊，請參閱[監視資料庫複寫](../../servers/manage/monitor-replication.md)。  


## <a name="site-database-replication-controls"></a><a name="BKMK_DBRepControls"></a> 站台資料庫複寫控制  

為協助您控制用於資料庫複寫的網路頻寬，請變更每個站台資料庫的設定。 這些設定只適用於您在其中進行設定的站台資料庫。 站台將資料庫複寫的任何資料複寫到任何其他站台時，一律會使用這些設定。  

您可以針對每個站台資料庫修改下列複寫控制：  

- SSB 連接埠  

- 複寫失敗觸發站台重新初始化其站台資料庫複本之前的等待時間  

- 壓縮站台複寫的資料。 它只會在壓縮站台之間傳送的資料，而不會壓縮儲存在任一站台之站台資料庫中的資料。  

若要變更站台資料庫的複寫控制項設定，請在 Configuration Manager 主控台的 [資料庫複寫]  節點上編輯站台資料庫的內容。 此節點會出現在 [系統管理]  工作區中的 [階層設定]  節點之下，也會出現在 [監視]  工作區中。 若要編輯站台資料庫的內容，請選取站台之間的複寫連結，然後開啟 [父資料庫內容]  或 [子資料庫內容]  。  

> [!TIP]  
> 您可以從任一工作區的 [資料庫複寫]  節點，設定資料庫複寫控制。 不過，當您使用 [監視]  工作區中的 [資料庫複寫]  節點時，也可以檢視複寫連結的資料庫複寫狀態，並存取 [複寫連結分析師] 工具，以協助調查複寫問題。  


## <a name="see-also"></a>請參閱

[監視複寫](../../servers/manage/monitor-replication.md)

[針對 SQL 複寫進行疑難排解](../../servers/manage/replication/overview.md)
